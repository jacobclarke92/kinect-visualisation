<!doctype html>

<html>
  <head>
    <meta charset="UTF-8">
    <title>Live Visuals | Controls</title>

    <!-- <link rel="stylesheet" type="text/css" href="styles.css"> -->

    <link rel="stylesheet" type="text/css" href="/scripts/webix.css">
    <link rel="stylesheet" type="text/css" href="/controls.css">
    <script type="text/javascript" src="/scripts/webix_debug.js"></script>



    <script type="text/javascript">

      String.prototype.capitalize = function() {
          return this.replace(/(?:^|\s)\S/g, function(a) { return a.toUpperCase(); });
      };
      String.prototype.readable = function() {

        return this.replace(/[_-]+(.)?/g,function(str) { return str.charAt(1).toUpperCase() }).replace(/([A-Z])/g, ' $1').replace(/^./, function(str){ return str.toUpperCase() })
      }



    	w = false;
    	controlsLoaded = true;
    	if (window.opener != null && !window.opener.closed) {
    		// window.opener.testConnection();
    		w = window.opener;
    	}
    	window.onunload = function() {
    		w.controlsClosed();
    	}
      var curDrag = false;
      var offsetLeft = 0;
      function windowResize() {
        offsetLeft = parseInt(w.jQuery('#frequencySelector',document).css('left'));
        console.log(offsetLeft);
      }
    	function loaded() {
    		// if(w) w.startPage('lsd1');
        windowResize();

        if(w.gotKinect) w.jQuery('#kinectCheck',document).removeClass('error');
        if(w.gotAudio) w.jQuery('#soundCheck',document).removeClass('error');

        w.jQuery('#leftSlider',document).bind('mousedown',function() {
          console.log('left slider click');
          curDrag = this;
        });
        w.jQuery('#rightSlider',document).bind('mousedown',function() {
          console.log('right slider click');
          curDrag = this;
        });

        w.jQuery(document,document).bind('mouseup',function() {
          curDrag = false;
        });
        w.jQuery(document,document).bind('mousemove',function(e) {
          if(curDrag != false) {
            var posX = e.clientX - offsetLeft;
            posX = posX < 0 ? 0 : posX > 512 ? 512 : posX;
            w.jQuery(curDrag).css('left',posX+'px');

            w.soundRange = [
              parseInt(w.jQuery('#leftSlider',document).css('left')),
              parseInt(w.jQuery('#rightSlider',document).css('left'))
            ];
            w.soundRange.sort();
            if(w.soundRange[0] > w.soundRange[1]) w.soundRange.reverse();
          }
        })
    	}

      function sliderChange() {
        // console.log(this);
        w.saveCookie();
      }
      function sliderDrag() {
        // if(this.data.name.indexOf('calib'))
        w.sliderDrag(this);
        console.log(this.getValue());
      }
      function checkboxToggle() {

      }
      function effectSelected() {
        var script = this._item_clicked;
        if(script != 'all_effects') w.changeScript(script);
      }


      var effectUI_data = [];

      //called from createControls function in mappings.js
      function updateEffectMappings() {

        var elems = $$('params_effect').elements;
        for(var key in elems) $$('params_effect').removeView(elems[key].data.id);

        if(w.mappings[w.hash].length == 0) $$('params_effect').addView({view: 'text', value: 'No options available for this effect...' });

        for(var i=0; i < w.mappings[w.hash].length; i++) {
          var m = w.mappings[w.hash][i];
          $$('params_effect').addView({
            view: 'slider', 
            label: m.name.readable(), 
            name: m.name, 
            min: m.min, max: m.max, 
            value: m.value, 
            on: {onChange: sliderChange, onSliderDrag: sliderDrag}
          });
        }
      }
    </script>


</head>
<body onload="loaded()" onkeypress="w.keyPressed(event)">

  <div id="statusIcons">
    <span class="error" id="soundCheck">
      <svg xmlns="http://www.w3.org/2000/svg" version="1" width="400pt" height="400pt" viewBox="0 0 75 75"><g stroke="#111" stroke-width="5"><path stroke-linejoin="round" fill="#111" d="M39.389 13.769l-17.154 14.837h-16.235v19.093h15.989l17.4 15.051v-48.981z"/><path id="path1" d="M48.128 49.03c1.929-3.096 3.062-6.739 3.062-10.653 0-3.978-1.164-7.674-3.147-10.8" stroke-linecap="round" fill="none"/><path d="M55.082 20.537c3.695 4.986 5.884 11.157 5.884 17.84 0 6.621-2.151 12.738-5.788 17.699" stroke-linecap="round" fill="none"/><path d="M61.71 62.611c5.267-6.666 8.418-15.08 8.418-24.233 0-9.217-3.192-17.682-8.519-24.368" stroke-linecap="round" fill="none"/></g></svg>
    </span>
    <span class="error" id="kinectCheck">
      <svg xmlns="http://www.w3.org/2000/svg" width="118" height="27"><defs><clipPath id="a"><path d="M0 88h200v-88h-200v88z"/></clipPath></defs><path d="M66.239 13.845c-2.503 0-4.532-2.027-4.532-4.532 0-2.503 2.029-4.533 4.532-4.533s4.532 2.03 4.532 4.533c0 2.505-2.029 4.532-4.532 4.532m-11.928 0c-2.503 0-4.533-2.027-4.533-4.532 0-2.503 2.03-4.533 4.533-4.533 2.503 0 4.532 2.03 4.532 4.533 0 2.505-2.029 4.532-4.532 4.532m-23.218 0c-2.503 0-4.533-2.027-4.533-4.532 0-2.503 2.03-4.533 4.533-4.533 2.503 0 4.532 2.03 4.532 4.533 0 2.505-2.029 4.532-4.532 4.532m82.46-13.837h-109.099c-2.45 0-4.452 2.004-4.452 4.455v9.382c0 2.45 2.002 4.454 4.452 4.454h52.323v1.239c-.453.004-.903.052-1.273.191-1.272.478-10.02 3.657-10.337 5.248-.32 1.591.953 1.591 3.339 1.591h20.993000000000002c2.386 0 3.657 0 3.341-1.591-.319-1.591-9.065-4.771-10.339-5.248-.369-.139-.819-.187-1.273-.191v-1.239h52.323c2.448 0 4.454-2.004 4.454-4.454v-9.382c0-2.451-2.006-4.455-4.454-4.455" fill="#00669c" clip-path="url(#a)"/></svg>
    </span>
  </div>
  <div id="volumeBar"></div>
  <div id="frequencySelector">
    <canvas id="frequencyBars" width="512" height="200"></canvas>
    <div id="leftSlider" class="slider"></div>
    <div id="rightSlider" class="slider"></div>
  </div>
  <br>
	<p>
      <script>

      var effectsUI_data = [];
      for(var n=0; n<w.effects.length; n++) {
        effectsUI_data.push({id: w.effects[n], value: (w.effects[n]).readable()});
      }
      var effectsUI = new webix.ui();

      // for(var n=0; n < w.effects.length; n++) {
      //   document.write('<a href="javascript:w.changeScript(\''+w.effects[n]+'\')" id="'+w.effects[n]+'" class="changeScript">'+w.effects[n]+'</a>');
      //   // if(n < w.effects.length-1) document.write(' | ');
      // }
      </script>
    </p>

    <div id="controlsZone"></div>
      <script>
        var cells = [
          {
            header: 'Effects List',
            id: 'tab_effects',
            body: {
              view: 'tree',
              select: true,
              on: {'onItemClick': effectSelected},
              data: [{
                id: 'all_effects', value: 'All Effects', open: true, data: effectsUI_data
              }]
            }
          },{
            header: "Effect Options",
            id: 'tab_effectOptions',
            body: {
              view: 'form', 
              id: 'params_effect', 
              elements: effectUI_data
            }
          },{
            header: "Filters",
            id: 'tab_filters',
            body: {
              view: 'form', id: 'params_filter', elements: [
                 {view: 'slider', label: 'RGB Split', name: 'filter_rgbSplit', min: 0, max: 100, value: 0, on: {onChange: sliderChange, onSliderDrag: sliderDrag}}
                ,{view: 'slider', label: 'Displacement', name: 'filter_displacement', min: 0, max: 100, value: 0, on:{onChange:sliderChange, onSliderDrag: sliderDrag}}
                ,{view: 'slider', label: 'Pixelate', name: 'filter_pixelate', min: 0, max: 100, value: 0, on:{onChange:sliderChange, onSliderDrag: sliderDrag}}
                ,{view: 'slider', label: 'Twist', name: 'filter_twist', min: 0, max: 100, value: 0, on:{onChange:sliderChange, onSliderDrag: sliderDrag}}
                ,{view: 'slider', label: 'Invert', name: 'filter_invert', min: -10, max: 10, value: 0, on:{onChange:sliderChange, onSliderDrag: sliderDrag}}
                ,{view: 'slider', label: 'Blur', name: 'filter_blur', min: 0, max: 100, value: 0, on:{onChange:sliderChange, onSliderDrag: sliderDrag}}

                //,{view: 'button', label: 'Reset', click: function() {$$("params_filter").refresh()}}
              ]
            }
            
          },{
            header: "Calibration",
            id: 'tab_calibration',
            view: 'form', id: 'params_calibration', elements: [
               {view: 'checkbox', label: 'Mirrored', name: 'calibration_mirrored', value: 0, on:{onChange:checkboxToggle}}
              ,{view: 'slider', label: 'Depth Threshold', name: 'calibration_depthThreshold', min: 100, max: 200, value: 0, on:{onChange:sliderChange, onSliderDrag: sliderDrag}}
              ,{view: 'slider', label: 'Depth Range', name: 'calibration_depthRange', min: 1, max: 50, value: 0, on:{onChange:sliderChange, onSliderDrag: sliderDrag}}
              ,{view: 'slider', label: 'Zoom', name: 'calibration_zoom', min: 0.2, max: 4, value: 0, on:{onChange:sliderChange, onSliderDrag: sliderDrag}}
              ,{view: 'slider', label: 'Offset X', name: 'calibration_offsetX', min: -200, max: 200, value: 0, on:{onChange:sliderChange, onSliderDrag: sliderDrag}}
              ,{view: 'slider', label: 'Offset Y', name: 'calibration_offsetY', min: -200, max: 200, value: 0, on:{onChange:sliderChange, onSliderDrag: sliderDrag}}
              ,{view: 'slider', label: 'Rotate X', name: 'calibration_rotateX', min: -65, max: 65, value: 0, on:{onChange:sliderChange, onSliderDrag: sliderDrag}}
              ,{view: 'slider', label: 'Rotate Y', name: 'calibration_rotateY', min: -65, max: 65, value: 0, on:{onChange:sliderChange, onSliderDrag: sliderDrag}}
              ,{view: 'slider', label: 'Perspective', name: 'calibration_perspective', min: 10, max: 2000, value: 800, on:{onChange:sliderChange, onSliderDrag: sliderDrag}}

              //,{view: 'button', label: 'Reset', click: function() {$$("params_calibration").refresh()}}
            ]
          }

        ];
        var paramsUI = new webix.ui({
          view: 'tabview',
          id: 'params',
          cells: cells
        });
      </script>
    </div>

    
    <!--
    <p style="clear:both">
      <input type="checkbox" id="imageToggle" onchange="w.toggleTesting('image',false); w.saveCookie()">
      <a href="javascript:w.randomizeImage()">Random test image</a> | 
      <a href="javascript:w.toggleTesting('sound',this)">Enable test sound</a>
    </p>
    <p>
      <input type="text" readonly value="chrome://settings/content#media-stream-settings" onclick="this.select()" style="width: 300px; text-align: center;">
    </p>
    -->

</body>
</html>